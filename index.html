<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management</title>
    <style>
        body { font-family: Arial; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .form-group { margin: 10px 0; }
        input, button { margin: 5px; padding: 8px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .photo { max-width: 50px; max-height: 50px; }
        .hidden { display: none; }
        .edit-btn { background: #4CAF50; color: white; border: none; padding: 5px 10px; cursor: pointer; margin: 2px; }
        .delete-btn { background: #f44336; color: white; border: none; padding: 5px 10px; cursor: pointer; margin: 2px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>User Management</h1>
        
        <div class="section">
            <h2 id="formTitle">Add User</h2>
            <form id="userForm">
                <input type="hidden" id="userId">
                
                <div class="form-group">
                    <input type="text" id="login" placeholder="Login" required>
                    <input type="password" id="password" placeholder="Password" required>
                    <input type="text" id="name" placeholder="Name" required>
                </div>
                
                <div class="form-group">
                    <input type="file" id="photoInput" accept="image/*">
                    <button type="button" id="removePhoto" class="hidden">Remove Photo</button>
                    <div id="photoPreview"></div>
                </div>
                
                <div class="form-group">
                    <button type="submit" id="submitBtn">Add</button>
                    <button type="button" id="cancelBtn" class="hidden">Cancel</button>
                </div>
            </form>
        </div>

        <div class="section">
            <h2>Users List</h2>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Login</th>
                        <th>Name</th>
                        <th>Photo</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersTable"></tbody>
            </table>
        </div>
    </div>

    <script>
        class UserManager {
            constructor() {
                this.users = [];
                this.isEditing = false;
                this.currentPhoto = null;
                this.init();
            }

            init() {
                document.getElementById('userForm').addEventListener('submit', (e) => this.handleSubmit(e));
                document.getElementById('cancelBtn').addEventListener('click', () => this.cancelEdit());
                document.getElementById('photoInput').addEventListener('change', (e) => this.handlePhoto(e));
                document.getElementById('removePhoto').addEventListener('click', () => this.removePhoto());
                
                this.loadUsers();
            }

            async loadUsers() {
                try {
                    const response = await fetch('/api/users');
                    if (!response.ok) throw new Error('Network error');
                    this.users = await response.json();
                    this.renderUsers();
                } catch (error) {
                    console.error('Error loading users:', error);
                    alert('Error loading users');
                }
            }

            renderUsers() {
                const tbody = document.getElementById('usersTable');
                tbody.innerHTML = this.users.map(user => `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.login}</td>
                        <td>${user.name}</td>
                        <td>${user.profilePhoto ? 
                            '<img src="data:' + user.photoMimeType + ';base64,' + user.profilePhoto + '" class="photo">' : 
                            'No photo'
                        }</td>
                        <td>
                            <button onclick="userManager.startEdit(${user.id})" class="edit-btn">Edit</button>
                            <button onclick="userManager.startDelete(${user.id})" class="delete-btn">Delete</button>
                        </td>
                    </tr>
                `).join('');
            }

            handlePhoto(event) {
                const file = event.target.files[0];
                if (!file) {
                    this.removePhoto();
                    return;
                }

                if (!file.type.startsWith('image/')) {
                    alert('Please select an image file');
                    this.removePhoto();
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    this.currentPhoto = e.target.result.split(',')[1];
                    document.getElementById('photoPreview').innerHTML = '<img src="' + e.target.result + '" class="photo">';
                    document.getElementById('removePhoto').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }

            removePhoto() {
                this.currentPhoto = null;
                document.getElementById('photoInput').value = '';
                document.getElementById('photoPreview').innerHTML = '';
                document.getElementById('removePhoto').classList.add('hidden');
            }

            async handleSubmit(e) {
                e.preventDefault();
                
                const userData = {
                    login: document.getElementById('login').value,
                    password: document.getElementById('password').value,
                    name: document.getElementById('name').value,
                    profilePhoto: this.currentPhoto,
                    photoMimeType: this.currentPhoto ? 'image/jpeg' : null
                };

                try {
                    const url = this.isEditing ? '/api/users/' + document.getElementById('userId').value : '/api/users';
                    const method = this.isEditing ? 'PUT' : 'POST';
                    
                    const response = await fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(userData)
                    });

                    if (response.ok) {
                        this.resetForm();
                        await this.loadUsers();
                        alert(this.isEditing ? 'User updated!' : 'User added!');
                    } else {
                        const error = await response.json();
                        alert('Error: ' + error.error);
                    }
                } catch (error) {
                    console.error('Error saving user:', error);
                    alert('Error saving user');
                }
            }

            async startEdit(id) {
                try {
                    const response = await fetch('/api/users/' + id);
                    if (!response.ok) throw new Error('Network error');
                    const user = await response.json();
                    
                    document.getElementById('userId').value = user.id;
                    document.getElementById('login').value = user.login;
                    document.getElementById('password').value = user.password;
                    document.getElementById('name').value = user.name;
                    
                    if (user.profilePhoto) {
                        this.currentPhoto = user.profilePhoto;
                        document.getElementById('photoPreview').innerHTML = 
                            '<img src="data:' + user.photoMimeType + ';base64,' + user.profilePhoto + '" class="photo">';
                        document.getElementById('removePhoto').classList.remove('hidden');
                    } else {
                        this.removePhoto();
                    }
                    
                    document.getElementById('formTitle').textContent = 'Edit User';
                    document.getElementById('submitBtn').textContent = 'Update';
                    document.getElementById('cancelBtn').classList.remove('hidden');
                    this.isEditing = true;
                } catch (error) {
                    console.error('Error loading user:', error);
                    alert('Error loading user');
                }
            }

            async startDelete(id) {
                console.log('Deleting user with ID:', id); // Логируем
                
                if (!confirm('Are you sure you want to delete this user?')) {
                    return;
                }

                try {
                    console.log('Sending DELETE request for ID:', id);
                    
                    const response = await fetch('/api/users/' + id, { 
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    console.log('Response status:', response.status);
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('Delete result:', result);
                        await this.loadUsers();
                        alert('User deleted successfully!');
                    } else {
                        const error = await response.json();
                        console.error('Delete error:', error);
                        alert('Error: ' + error.error);
                    }
                } catch (error) {
                    console.error('Error deleting user:', error);
                    alert('Error deleting user: ' + error.message);
                }
            }

            cancelEdit() {
                this.resetForm();
            }

            resetForm() {
                document.getElementById('userForm').reset();
                document.getElementById('userId').value = '';
                this.removePhoto();
                document.getElementById('formTitle').textContent = 'Add User';
                document.getElementById('submitBtn').textContent = 'Add';
                document.getElementById('cancelBtn').classList.add('hidden');
                this.isEditing = false;
                this.currentPhoto = null;
            }
        }

        // Глобальная переменная для доступа из onclick
        const userManager = new UserManager();
    </script>
</body>
</html>